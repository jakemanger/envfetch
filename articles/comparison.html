<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Comparison with other extraction methods • envfetch</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Comparison with other extraction methods">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">envfetch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/comparison.html">Comparison with other extraction methods</a></li>
    <li><a class="dropdown-item" href="../articles/using-internal-functions-of-envfetch.html">Using internal functions of envfetch</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Comparison with other extraction methods</h1>
            
      

      <div class="d-none name"><code>comparison.Rmd</code></div>
    </div>

    
    
<p>There are many existing R packages to extract raster data at
locations of vector geometries (points, lines or polygons). However,
when your vector geometries are combined with time (single datetimes or
intervals), large raster files and many combinations of space and time
to be extracted, the default strategies to use these packages are slow
or use too much RAM (often causing crashes).</p>
<p>Envfetch uses <code>sf</code> , <code>terra</code> and
<code>stars</code> package in an optimal way for fast and
memory-efficient extraction of raster data over space and time. Each
optimisation has been implemented in the simple <code><a href="../reference/envfetch.html">envfetch()</a></code>
function, and this vignette functions as a reasoning for these
optimisations. For a guide on how to use <code><a href="../reference/envfetch.html">envfetch()</a></code>
optimisations automatically applied, see <a href=""></a>.</p>
<p>All below code examples use a mock dataset created with the following
code:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jakemanger.github.io/envfetch/">envfetch</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/" class="external-link">stars</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/terraOptions.html" class="external-link">terraOptions</a></span><span class="op">(</span>progress<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">num_benchmark_repeats</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span></span>
<span><span class="va">tif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">'2018-01-01'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">'2018-09-21'</span><span class="op">)</span>, <span class="st">'day'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">r</span>, <span class="fl">44</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">:</span><span class="fl">264</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">dates</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/throw.html">throw</a></span><span class="op">(</span></span>
<span>  offset<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">288700</span>, <span class="fl">9110700</span><span class="op">)</span>,</span>
<span>  cellsize<span class="op">=</span><span class="fl">10000</span><span class="op">/</span><span class="fl">32</span>,</span>
<span>  n<span class="op">=</span><span class="fl">32</span>,</span>
<span>  time_interval<span class="op">=</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">interval</a></span><span class="op">(</span>start<span class="op">=</span><span class="st">'2018-01-01'</span>, end<span class="op">=</span><span class="st">'2018-01-01'</span><span class="op">)</span>,</span>
<span>  crs<span class="op">=</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">num_intervals</span> <span class="op">&lt;-</span> <span class="fl">128</span></span>
<span><span class="va">interval_length</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">/</span> <span class="va">num_intervals</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_intervals</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">start_idx</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">interval_length</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="va">end_idx</span> <span class="op">&lt;-</span> <span class="va">i</span> <span class="op">*</span> <span class="va">interval_length</span></span>
<span>  <span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2018-01-01"</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">end_time</span> <span class="op">&lt;-</span> <span class="va">start_time</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="va">p</span><span class="op">$</span><span class="va">time_column</span><span class="op">[</span><span class="va">start_idx</span><span class="op">:</span><span class="va">end_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">interval</a></span><span class="op">(</span>start<span class="op">=</span><span class="va">start_time</span>, end<span class="op">=</span><span class="va">end_time</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">extracted</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-3-1.png" width="900" height="600"></p>
<div class="section level2">
<h2 id="extract-once">Extract once<a class="anchor" aria-label="anchor" href="#extract-once"></a>
</h2>
<p>The simplest approach to extract over space and time is to summarise
rasters temporally and then extract spatially within the locations of
your vector data. For one time range, existing solutions are well suited
to this task. Below is an example with the <code>terra</code>
package:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">one_time_range</span> <span class="op">&lt;-</span> <span class="va">p</span></span>
<span><span class="va">one_time_range</span><span class="op">$</span><span class="va">time_column</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">interval</a></span><span class="op">(</span>start<span class="op">=</span><span class="st">'2018-01-01'</span>, end<span class="op">=</span><span class="st">'2018-01-02'</span><span class="op">)</span></span>
<span><span class="va">extract_one_time_range</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mean_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">r</span><span class="op">[[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="st">'2018-01-01'</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="st">'2018-01-02'</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">mean_r</span>, <span class="va">one_time_range</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">extract_one_time_range</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ID mean</span></span>
<span><span class="co">#&gt; 1  1 63.0</span></span>
<span><span class="co">#&gt; 2  2 66.5</span></span>
<span><span class="co">#&gt; 3  3 66.5</span></span>
<span><span class="co">#&gt; 4  4 70.0</span></span>
<span><span class="co">#&gt; 5  5 59.5</span></span>
<span><span class="co">#&gt; 6  6 64.5</span></span>
<span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="fu">extract_one_time_range</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  times<span class="op">=</span><span class="va">num_benchmark_repeats</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Unit: milliseconds</span></span>
<span><span class="co">#&gt;                      expr      min      lq     mean   median       uq     max</span></span>
<span><span class="co">#&gt;  extract_one_time_range() 25.45823 25.7993 37.15441 25.93303 26.56069 82.0208</span></span>
<span><span class="co">#&gt;  neval</span></span>
<span><span class="co">#&gt;      5</span></span></code></pre></div>
<p>Taking our first approach to multiple time ranges starts to give us
problems. For this approach to scale, we need to repeat our extraction
multiple times for each time range. This results in us requiring
approximately twice the time for two time ranges, triple the time for
three time ranges and so on.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extract_n_time_ranges</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">unique_time_ranges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">time_column</span><span class="op">)</span></span>
<span>  <span class="va">unique_time_ranges</span> <span class="op">&lt;-</span> <span class="va">unique_time_ranges</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span></span>
<span>  <span class="co"># loop through each unique time range and extract</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">unique_time_ranges</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">t</span> <span class="op">&lt;-</span> <span class="va">unique_time_ranges</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="va">indx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">time_column</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span>    <span class="va">mean_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">r</span><span class="op">[[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">int_start</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">int_end</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">subset</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">[</span><span class="va">indx</span>,<span class="op">]</span></span>
<span>    <span class="va">p</span><span class="op">$</span><span class="va">extracted</span><span class="op">[</span><span class="va">indx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">mean_r</span>, <span class="va">subset</span>, ID<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">mean</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="fu">extract_n_time_ranges</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_n_time_ranges</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_n_time_ranges</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_n_time_ranges</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">8</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_n_time_ranges</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">16</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_n_time_ranges</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">32</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_n_time_ranges</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">64</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_n_time_ranges</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  times<span class="op">=</span><span class="va">num_benchmark_repeats</span></span>
<span><span class="op">)</span></span>
<span><span class="va">bm</span></span>
<span><span class="co">#&gt; Unit: milliseconds</span></span>
<span><span class="co">#&gt;                                  expr        min         lq       mean</span></span>
<span><span class="co">#&gt;    extract_n_time_ranges(n = 1, p, r)   27.44140   31.62757   36.08675</span></span>
<span><span class="co">#&gt;    extract_n_time_ranges(n = 2, p, r)   54.43676   59.86843   68.34834</span></span>
<span><span class="co">#&gt;    extract_n_time_ranges(n = 4, p, r)   91.79607   97.80014  109.63029</span></span>
<span><span class="co">#&gt;    extract_n_time_ranges(n = 8, p, r)  180.98658  181.40988  197.75527</span></span>
<span><span class="co">#&gt;   extract_n_time_ranges(n = 16, p, r)  357.68348  361.21339  390.64894</span></span>
<span><span class="co">#&gt;   extract_n_time_ranges(n = 32, p, r)  706.60187  713.34007  805.53002</span></span>
<span><span class="co">#&gt;   extract_n_time_ranges(n = 64, p, r) 1418.96821 1425.39308 1561.40054</span></span>
<span><span class="co">#&gt;  extract_n_time_ranges(n = 128, p, r) 2963.58808 2997.62796 3356.13717</span></span>
<span><span class="co">#&gt;      median         uq        max neval</span></span>
<span><span class="co">#&gt;    33.20024   39.46661   48.69791     5</span></span>
<span><span class="co">#&gt;    62.88997   81.56425   82.98229     5</span></span>
<span><span class="co">#&gt;   109.76728  123.51309  125.27489     5</span></span>
<span><span class="co">#&gt;   183.35136  189.47982  253.54874     5</span></span>
<span><span class="co">#&gt;   361.44171  419.24629  453.65982     5</span></span>
<span><span class="co">#&gt;   769.75713  885.35870  952.59232     5</span></span>
<span><span class="co">#&gt;  1579.16911 1651.68968 1731.78260     5</span></span>
<span><span class="co">#&gt;  3255.74714 3748.75837 3814.96433     5</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-5-1.png" width="900" height="600"></p>
<p>When your vector data has many time ranges, a faster solution is to
instead do one single extraction for all time ranges and then summarise
the data. This avoids repeating the expensive extraction operation.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extract_once</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># subset to only have the time columns we are interested in</span></span>
<span>  <span class="va">time_column</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="va">time_column</span></span>
<span>  <span class="va">unique_time_ranges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">time_column</span><span class="op">)</span></span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">time_column</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="va">unique_time_ranges</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">[</span><span class="va">index</span>,<span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">extracted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">p</span>, ID<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span></span>
<span>    <span class="fu">envfetch</span><span class="fu">:::</span><span class="fu">non_vectorised_summarisation</span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">x</span>,</span>
<span>      extracted <span class="op">=</span> <span class="va">extracted</span>,</span>
<span>      IDs <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>      temporal_fun <span class="op">=</span> <span class="va">mean</span>,</span>
<span>      tms <span class="op">=</span> <span class="va">times</span>,</span>
<span>      nms <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">extracted</span><span class="op">)</span>,</span>
<span>      time_column_name <span class="op">=</span> <span class="st">'time_column'</span>,</span>
<span>      new_col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'L7_ETMs'</span><span class="op">)</span>,</span>
<span>      multi_values_in_extraction_per_row <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">extracted_multiple_times</span> <span class="op">&lt;-</span> <span class="fu">extract_n_time_ranges</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span></span>
<span><span class="va">extracted_once</span> <span class="op">&lt;-</span> <span class="fu">extract_once</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">extracted_multiple_times</span><span class="op">$</span><span class="va">extracted</span>, <span class="va">extracted_once</span><span class="op">$</span><span class="va">L7_ETMs</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="fu">extract_n_time_ranges</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_once</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  times<span class="op">=</span><span class="va">num_benchmark_repeats</span></span>
<span><span class="op">)</span></span>
<span><span class="va">bm</span></span>
<span><span class="co">#&gt; Unit: seconds</span></span>
<span><span class="co">#&gt;                                  expr      min       lq     mean   median</span></span>
<span><span class="co">#&gt;  extract_n_time_ranges(n = 128, p, r) 2.904303 3.085495 3.296403 3.250362</span></span>
<span><span class="co">#&gt;           extract_once(n = 128, p, r) 1.234733 1.258795 1.484642 1.556721</span></span>
<span><span class="co">#&gt;        uq      max neval</span></span>
<span><span class="co">#&gt;  3.535701 3.706151     5</span></span>
<span><span class="co">#&gt;  1.675362 1.697599     5</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-6-1.png" width="900" height="600"></p>
</div>
<div class="section level2">
<h2 id="only-extract-the-time-slices-you-are-interested-in">Only extract the time slices you are interested in<a class="anchor" aria-label="anchor" href="#only-extract-the-time-slices-you-are-interested-in"></a>
</h2>
<p>Although it’s faster to extract once, it may still be slow in cases
where the raster stack is very large or times to extract are far from
one another in the raster stack.</p>
<p>The solution is that we do not need to extract all time slices of the
data. A simple optimisation is to trim the time range of the raster
around the minimum and maximum of our vector data, e.g. 
<code>r[[times(r) &gt; min_time &amp; times(r) &lt; min_time]]</code>.
This would help if the time ranges you wish to extract are close
together within a raster stack.</p>
<p>But to also optimise in other cases, especially when time ranges are
far from one another, we can only extract from the time slices we are
interested in. This is achievable by sub-setting the raster before the
extraction with only the relevant time slices (calculated by the
<code>find_relevant_time_slices()</code> function in
<code>envfetch</code>).</p>
<p>Note, time to calculate the relevant time slices can be more than you
benefit from the reduced extraction if time ranges to extract are close
to one another and the raster stack is small. We can see this in the
below plot where extracting only what we need only has a benefit when
extracting from a large raster with time slices far from one
another.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">large_p</span> <span class="op">&lt;-</span> <span class="va">p</span></span>
<span><span class="va">large_p</span><span class="op">$</span><span class="va">time_column</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">interval</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">int_start</a></span><span class="op">(</span><span class="va">large_p</span><span class="op">$</span><span class="va">time_column</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">years</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">int_end</a></span><span class="op">(</span><span class="va">large_p</span><span class="op">$</span><span class="va">time_column</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">years</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">large_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">large_p</span><span class="op">)</span></span>
<span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">int_start</a></span><span class="op">(</span><span class="va">large_p</span><span class="op">$</span><span class="va">time_column</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">int_end</a></span><span class="op">(</span><span class="va">large_p</span><span class="op">$</span><span class="va">time_column</span><span class="op">)</span><span class="op">)</span>, <span class="st">'day'</span><span class="op">)</span></span>
<span><span class="va">large_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span></span>
<span><span class="va">large_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">large_r</span>, <span class="fl">326</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1955</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">large_r</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">dates</span></span>
<span></span>
<span><span class="va">extract_only_what_we_need</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># subset to only have the time columns we are interested in</span></span>
<span>  <span class="va">time_column</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="va">time_column</span></span>
<span>  <span class="va">unique_time_ranges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">time_column</span><span class="op">)</span></span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">time_column</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="va">unique_time_ranges</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">[</span><span class="va">index</span>,<span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">relevant_time_slices</span> <span class="op">&lt;-</span> <span class="fu">envfetch</span><span class="fu">:::</span><span class="fu">find_relevant_time_slices</span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span>, <span class="va">x</span><span class="op">$</span><span class="va">time_column</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">[[</span><span class="va">relevant_time_slices</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">extracted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">p</span>, ID<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span></span>
<span>    <span class="fu">envfetch</span><span class="fu">:::</span><span class="fu">non_vectorised_summarisation</span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">x</span>,</span>
<span>      extracted <span class="op">=</span> <span class="va">extracted</span>,</span>
<span>      IDs <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>      temporal_fun <span class="op">=</span> <span class="va">mean</span>,</span>
<span>      tms <span class="op">=</span> <span class="va">times</span>,</span>
<span>      nms <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">extracted</span><span class="op">)</span>,</span>
<span>      time_column_name <span class="op">=</span> <span class="st">'time_column'</span>,</span>
<span>      new_col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'L7_ETMs'</span><span class="op">)</span>,</span>
<span>      multi_values_in_extraction_per_row <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">extracted_only_what_we_need</span> <span class="op">&lt;-</span> <span class="fu">extract_only_what_we_need</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">extracted_multiple_times</span><span class="op">$</span><span class="va">extracted</span>, <span class="va">extracted_only_what_we_need</span><span class="op">$</span><span class="va">L7_ETMs</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="fu">extract_n_time_ranges</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_once</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_only_what_we_need</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_n_time_ranges</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">256</span>, <span class="va">large_p</span>, <span class="va">large_r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_once</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">256</span>, <span class="va">large_p</span>, <span class="va">large_r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_only_what_we_need</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">256</span>, <span class="va">large_p</span>, <span class="va">large_r</span><span class="op">)</span>,</span>
<span>  times<span class="op">=</span><span class="va">num_benchmark_repeats</span></span>
<span><span class="op">)</span></span>
<span><span class="va">bm</span></span>
<span><span class="co">#&gt; Unit: seconds</span></span>
<span><span class="co">#&gt;                                                  expr      min       lq</span></span>
<span><span class="co">#&gt;                  extract_n_time_ranges(n = 128, p, r) 2.915962 3.052463</span></span>
<span><span class="co">#&gt;                           extract_once(n = 128, p, r) 1.238042 1.242041</span></span>
<span><span class="co">#&gt;              extract_only_what_we_need(n = 128, p, r) 1.490884 1.511225</span></span>
<span><span class="co">#&gt;      extract_n_time_ranges(n = 256, large_p, large_r) 6.247511 6.319033</span></span>
<span><span class="co">#&gt;               extract_once(n = 256, large_p, large_r) 3.463964 3.655003</span></span>
<span><span class="co">#&gt;  extract_only_what_we_need(n = 256, large_p, large_r) 4.325404 4.478563</span></span>
<span><span class="co">#&gt;      mean   median       uq      max neval</span></span>
<span><span class="co">#&gt;  3.261666 3.338140 3.413433 3.588334     5</span></span>
<span><span class="co">#&gt;  1.296904 1.255624 1.292521 1.456295     5</span></span>
<span><span class="co">#&gt;  1.613402 1.628754 1.693775 1.742370     5</span></span>
<span><span class="co">#&gt;  6.327814 6.326538 6.370509 6.375479     5</span></span>
<span><span class="co">#&gt;  3.664313 3.666039 3.692901 3.843657     5</span></span>
<span><span class="co">#&gt;  4.674067 4.485122 4.872006 5.209237     5</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-7-1.png" width="900" height="600"></p>
<p>For cases where you intend to extract single time slices not time
ranges for each geometry, we have also implemented a wrapper around the
approach used by <code>stars</code> in their <code>st_extract</code>
function. This uses a similar approach by only extracting the time
slices needed.</p>
</div>
<div class="section level2">
<h2 id="vectorise-summarisation-functions">Vectorise summarisation functions<a class="anchor" aria-label="anchor" href="#vectorise-summarisation-functions"></a>
</h2>
<p>Another optimisation is in the summarisation step. R is slow at
running tasks repeatedly (e.g. row by row). Offsetting that task to a
faster programming language under the hood is possible with vectorised
functions. Functions like <code><a href="https://rspatial.github.io/terra/reference/rowSums.html" class="external-link">rowMeans()</a></code> and
<code><a href="https://rspatial.github.io/terra/reference/rowSums.html" class="external-link">rowSums()</a></code> are written in C instead of R. As a result, they
don’t require as much overhead (of the R interpreter), giving us further
performance gains.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extract_only_what_we_need_vectorised</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># subset to only have the time columns we are interested in</span></span>
<span>  <span class="va">time_column</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="va">time_column</span></span>
<span>  <span class="va">unique_time_ranges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">time_column</span><span class="op">)</span></span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">time_column</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="va">unique_time_ranges</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">[</span><span class="va">index</span>,<span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">relevant_time_slices</span> <span class="op">&lt;-</span> <span class="fu">envfetch</span><span class="fu">:::</span><span class="fu">find_relevant_time_slices</span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span>, <span class="va">x</span><span class="op">$</span><span class="va">time_column</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">[[</span><span class="va">relevant_time_slices</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">extracted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">p</span>, ID<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span></span>
<span>    <span class="fu">envfetch</span><span class="fu">:::</span><span class="fu">vectorised_summarisation</span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">x</span>,</span>
<span>      extracted <span class="op">=</span> <span class="va">extracted</span>,</span>
<span>      temporal_fun <span class="op">=</span> <span class="va">rowMeans</span>,</span>
<span>      tms <span class="op">=</span> <span class="va">times</span>,</span>
<span>      nms <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">extracted</span><span class="op">)</span>,</span>
<span>      time_column_name <span class="op">=</span> <span class="st">'time_column'</span>,</span>
<span>      new_col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'L7_ETMs'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">extracted_only_what_we_need_vectorised</span> <span class="op">&lt;-</span> <span class="fu">extract_only_what_we_need_vectorised</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">extracted_only_what_we_need</span><span class="op">$</span><span class="va">L7_ETMs</span>, <span class="va">extracted_only_what_we_need_vectorised</span><span class="op">$</span><span class="va">L7_ETMs</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="fu">extract_only_what_we_need</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_only_what_we_need_vectorised</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span><span class="op">)</span>,</span>
<span>  times<span class="op">=</span><span class="va">num_benchmark_repeats</span></span>
<span><span class="op">)</span></span>
<span><span class="va">bm</span></span>
<span><span class="co">#&gt; Unit: milliseconds</span></span>
<span><span class="co">#&gt;                                           expr       min        lq      mean</span></span>
<span><span class="co">#&gt;       extract_only_what_we_need(n = 128, p, r) 1458.9340 1467.7678 1483.0301</span></span>
<span><span class="co">#&gt;  extract_only_what_we_need_vectorised(n = 128)  470.8823  472.1714  483.4074</span></span>
<span><span class="co">#&gt;     median       uq      max neval</span></span>
<span><span class="co">#&gt;  1482.0416 1499.382 1507.025     5</span></span>
<span><span class="co">#&gt;   487.6604  488.694  497.629     5</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-8-1.png" width="900" height="600"></p>
</div>
<div class="section level2">
<h2 id="dont-repeat-yourself">Don’t repeat yourself<a class="anchor" aria-label="anchor" href="#dont-repeat-yourself"></a>
</h2>
<p>Finally, using existing packages with repeated data results in
repeated extractions. That is, if you provide extraction functions with
the same data point multiple times, it will extract that point multiple
times.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">duplicated_p</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">extract_duplicated_only_what_we_need_vectorised</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># subset to only have the time columns we are interested in</span></span>
<span>  <span class="va">time_column</span> <span class="op">&lt;-</span> <span class="va">duplicated_p</span><span class="op">$</span><span class="va">time_column</span></span>
<span>  <span class="va">unique_time_ranges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">time_column</span><span class="op">)</span></span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">time_column</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="va">unique_time_ranges</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span></span>
<span>  <span class="va">duplicated_p</span> <span class="op">&lt;-</span> <span class="va">duplicated_p</span><span class="op">[</span><span class="va">index</span>,<span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">duplicated_p</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">relevant_time_slices</span> <span class="op">&lt;-</span> <span class="fu">envfetch</span><span class="fu">:::</span><span class="fu">find_relevant_time_slices</span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span>, <span class="va">x</span><span class="op">$</span><span class="va">time_column</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">[[</span><span class="va">relevant_time_slices</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">extracted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">duplicated_p</span>, ID<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span></span>
<span>    <span class="fu">envfetch</span><span class="fu">:::</span><span class="fu">vectorised_summarisation</span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">x</span>,</span>
<span>      extracted <span class="op">=</span> <span class="va">extracted</span>,</span>
<span>      temporal_fun <span class="op">=</span> <span class="va">rowMeans</span>,</span>
<span>      tms <span class="op">=</span> <span class="va">times</span>,</span>
<span>      nms <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">extracted</span><span class="op">)</span>,</span>
<span>      time_column_name <span class="op">=</span> <span class="st">'time_column'</span>,</span>
<span>      new_col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'L7_ETMs'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">repeated_extraction_without_duplicates</span> <span class="op">&lt;-</span> <span class="fu">extract_only_what_we_need_vectorised</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span><span class="op">)</span></span>
<span><span class="va">repeated_extraction_with_duplicates</span> <span class="op">&lt;-</span> <span class="fu">extract_duplicated_only_what_we_need_vectorised</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span><span class="op">)</span></span>
<span></span>
<span><span class="va">non_repeated_extraction_without_duplicates</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/envfetch.html">envfetch</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">r</span>, use_cache<span class="op">=</span><span class="cn">FALSE</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">non_repeated_extraction_with_duplicates</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/envfetch.html">envfetch</a></span><span class="op">(</span><span class="va">duplicated_p</span>, <span class="va">r</span>, use_cache<span class="op">=</span><span class="cn">FALSE</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">repeated_extraction_with_duplicates</span><span class="op">$</span><span class="va">L7_ETMs</span>, <span class="va">non_repeated_extraction_with_duplicates</span><span class="op">$</span><span class="va">L7_ETMs</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="fu">extract_only_what_we_need_vectorised</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span><span class="op">)</span>,</span>
<span>  <span class="fu">extract_duplicated_only_what_we_need_vectorised</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/envfetch.html">envfetch</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">r</span>, use_cache<span class="op">=</span><span class="cn">FALSE</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/envfetch.html">envfetch</a></span><span class="op">(</span><span class="va">duplicated_p</span>, <span class="va">r</span>, use_cache<span class="op">=</span><span class="cn">FALSE</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  times<span class="op">=</span><span class="va">num_benchmark_repeats</span></span>
<span><span class="op">)</span></span>
<span><span class="va">bm</span></span>
<span><span class="co">#&gt; Unit: milliseconds</span></span>
<span><span class="co">#&gt;                                                           expr       min</span></span>
<span><span class="co">#&gt;                  extract_only_what_we_need_vectorised(n = 128)  461.8787</span></span>
<span><span class="co">#&gt;       extract_duplicated_only_what_we_need_vectorised(n = 128) 1138.8091</span></span>
<span><span class="co">#&gt;             envfetch(p, r, use_cache = FALSE, verbose = FALSE) 1933.9714</span></span>
<span><span class="co">#&gt;  envfetch(duplicated_p, r, use_cache = FALSE, verbose = FALSE) 1954.1011</span></span>
<span><span class="co">#&gt;         lq      mean    median        uq      max neval</span></span>
<span><span class="co">#&gt;   461.9401  466.8124  466.5142  471.5651  472.164     5</span></span>
<span><span class="co">#&gt;  1140.4238 1198.5104 1154.9586 1172.6416 1385.719     5</span></span>
<span><span class="co">#&gt;  1936.0873 1936.3364 1936.1135 1937.2932 1938.216     5</span></span>
<span><span class="co">#&gt;  1957.7536 2011.8230 1958.9421 1967.6205 2220.698     5</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-9-1.png" width="900" height="600"></p>
<p>Similarly, if you have already extracted the data once, why extract
it again? Saving data after an extraction and reloading it when needed
is convenient and saves time, especially if an extraction pipeline fails
or crashes part of the way through or if you want to use the data
between R sessions. For convenience, storing data for future requests
(caching) is done automatically by <code><a href="../reference/envfetch.html">envfetch()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extracted</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/envfetch.html">envfetch</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">r</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># after running the first time above, the result is loaded straight from the cache</span></span>
<span><span class="co"># and not computed again</span></span>
<span><span class="va">extracted</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/envfetch.html">envfetch</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">r</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="x-speed-improvement">&gt; 15x speed improvement<a class="anchor" aria-label="anchor" href="#x-speed-improvement"></a>
</h2>
<p>The above optimisations result in the speed benefits found in the
<code>envfetch</code> function.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="fu">extract_n_time_ranges</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">128</span>, <span class="va">p</span>, <span class="va">r</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/envfetch.html">envfetch</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">r</span>, use_cache <span class="op">=</span> <span class="cn">FALSE</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  times<span class="op">=</span><span class="va">num_benchmark_repeats</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          </span></span>
<span><span class="va">bm</span></span>
<span><span class="co">#&gt; Unit: seconds</span></span>
<span><span class="co">#&gt;                                                expr      min       lq     mean</span></span>
<span><span class="co">#&gt;                extract_n_time_ranges(n = 128, p, r) 2.824019 2.861804 2.925474</span></span>
<span><span class="co">#&gt;  envfetch(p, r, use_cache = FALSE, verbose = FALSE) 1.925748 1.933606 1.946099</span></span>
<span><span class="co">#&gt;    median       uq      max neval</span></span>
<span><span class="co">#&gt;  2.905737 2.915974 3.119837     5</span></span>
<span><span class="co">#&gt;  1.934837 1.937643 1.998660     5</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-11-1.png" width="900" height="600"></p>
<p>Going from the most naive extraction solution with our small example
(128 time intervals), we have changed our extraction time from 15
seconds to 1 second. That is a speed up of 15x. Note, these benefits get
larger both with the number of time intervals that need to be extracted
and how far in time time intervals are from one another in the raster
file. Extraction tasks that would otherwise take multiple days can be
achievable in minutes or hours with <code>envfetch</code>.</p>
<p>To ensure this extraction process is possible on lower-end machines,
there are further strategies to optimise RAM usage described below.</p>
</div>
<div class="section level2">
<h2 id="dont-overuse-ram">Don’t overuse RAM<a class="anchor" aria-label="anchor" href="#dont-overuse-ram"></a>
</h2>
<p>In an ideal world, it would be best to extract all the data necessary
for the extraction at once. However, the amount of data a computer can
extract at once is limited by how much RAM it has.</p>
<p>To allow computers with less RAM to complete the same extraction
task, we can separate extractions into smaller chunks. These can then be
processed one at a time, limiting RAM usage within the available limits.
We have implemented an automatic system to extract data in chunks in the
<code>extract_over_space</code> function, used internally by
<code><a href="../reference/envfetch.html">envfetch()</a></code>.</p>
<p>Remember, all these optimisations are built into the
<code><a href="../reference/envfetch.html">envfetch()</a></code> function so you don’t need to repeat this when
extracting your dataset.</p>
</div>
<div class="section level2">
<h2 id="run-on-google-cloud">Run on google cloud<a class="anchor" aria-label="anchor" href="#run-on-google-cloud"></a>
</h2>
<p>In cases where downloading of local files for extracting data are not
possible or practical, cloud solutions can provide a performant
alternative. The largest and most commonly used cloud-based geospatial
analysis platform is Google Earth Engine.</p>
<p>Currently, there is one R package with an implemented extraction
function for Google earth engine, <code>rgee</code>. However, with large
datasets or extraction tasks, standard use of the
<code><a href="https://r-spatial.github.io/rgee/reference/ee_extract.html" class="external-link">rgee::ee_extract</a></code> function can causes crashes or overuse of
Google Earth Engine’s memory limits, failing the extraction task.</p>
<p>We have implemented processing data in chunks with the
<code>extract_gee</code> function, used internally by
<code><a href="../reference/envfetch.html">envfetch()</a></code>, to allow processing of more data, while
remaining within your quota limits (<a href="https://developers.google.com/earth-engine/guides/usage#adjustable_quota_limits" class="external-link uri">https://developers.google.com/earth-engine/guides/usage#adjustable_quota_limits</a>).</p>
<p>Using <code>ee_extract</code> from <code>rgee</code> will by default
fail with this dataset.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rgee</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/rgee/reference/ee_Initialize.html" class="external-link">ee_Initialize</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># first half of extraction process (extracting between all time ranges)</span></span>
<span><span class="va">p_feature</span> <span class="op">&lt;-</span> <span class="fu">rgee</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/rgee/reference/sf_as_ee.html" class="external-link">sf_as_ee</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">large_p</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ic</span> <span class="op">&lt;-</span> <span class="fu">rgee</span><span class="fu">::</span><span class="va"><a href="https://r-spatial.github.io/rgee/reference/ee.html" class="external-link">ee</a></span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">'MODIS/061/MOD13Q1'</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">filterBounds</span><span class="op">(</span><span class="va">p_feature</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">filterDate</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">int_start</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">time_column</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">int_end</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">time_column</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">rgee_extracted</span> <span class="op">&lt;-</span> <span class="fu">rgee</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/rgee/reference/ee_extract.html" class="external-link">ee_extract</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">ic</span>,</span>
<span>  y <span class="op">=</span> <span class="va">p_feature</span>,</span>
<span>  scale <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  fun <span class="op">=</span> <span class="fu">rgee</span><span class="fu">::</span><span class="va"><a href="https://r-spatial.github.io/rgee/reference/ee.html" class="external-link">ee</a></span><span class="op">$</span><span class="va">Reducer</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  lazy <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  sf <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in py_call_impl(callable, call_args$unnamed, call_args$named) :</span></span>
<span><span class="co">#&gt; ee.ee_exception.EEException: User memory limit exceeded.</span></span>
<span><span class="co">#&gt; Run `reticulate::py_last_error()` for details.</span></span>
<span></span>
<span><span class="co"># ... you would then also need to make a custom solution to summarise this data</span></span></code></pre></div>
<p><code>envfetch</code> will process this same task in chunks to ensure
it does not fail. It will also summarise the data for you.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">envfetch_extracted</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/envfetch.html">envfetch</a></span><span class="op">(</span><span class="va">large_p</span>, <span class="st">'MODIS/061/MOD13Q1'</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── rgee 1.1.5 ───────────────────────────────────────────────────────────────────────────────────────── earthengine-api 0.1.374 ── </span></span>
<span><span class="co">#&gt;  ✔ user: not_defined</span></span>
<span><span class="co">#&gt;  ✔ Initializing Google Earth Engine:  DONE!</span></span>
<span><span class="co">#&gt;  ✔ Earth Engine account: users/dungbeetlelab </span></span>
<span><span class="co">#&gt; ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── 🥏 🐕 Fetching your data ──────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; → Parsing time column</span></span>
<span><span class="co">#&gt; ℹ Running ~extract_gee(x = .x, collection_name = r, bands = bands, temporal_fun = temporal_fun, ee_reducer_fun = spatial_fun, initialise_gee = FALSE, ...)</span></span>
<span><span class="co">#&gt; Number of features: 500                     </span></span>
<span><span class="co">#&gt; Number of features: 500                                               17% | ETA:  3m</span></span>
<span><span class="co">#&gt; Number of features: 24                     ■■■■                       33% | ETA:  3m</span></span>
<span><span class="co">#&gt; Number of features: 500                     ■■■■■■■■                  50% | ETA:  2m</span></span>
<span><span class="co">#&gt; Number of features: 500                     ■■■■■■■■■■■■■             67% | ETA:  1m</span></span>
<span><span class="co">#&gt; Number of features: 24                     ■■■■■■■■■■■■■■■■■■■        83% | ETA: 44s</span></span>
<span><span class="co">#&gt; → Summarising extracted data over specified times                                    </span></span>
<span><span class="co">#&gt; ✔ 🐶 Completed ~extract_gee(x = .x, collection_name = r, bands = bands, temporal_fun = temporal_fun, ee_reducer_fun = spatial_fun, initialise_gee = FALSE, ...)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── 🐩 Fetched ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span></code></pre></div>
<p>The chunk size can be optimised for your particular task by modifying
the <code>max_chunk_time_day_range</code> and
<code>max_feature_collection_size</code> arguments in
<code><a href="../reference/envfetch.html">envfetch()</a></code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jake Manger, Jacob Berson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
