<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using internal functions of envfetch • envfetch</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using internal functions of envfetch">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">envfetch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/comparison.html">Comparison with other extraction methods</a></li>
    <li><a class="dropdown-item" href="../articles/using-internal-functions-of-envfetch.html">Using internal functions of envfetch</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Using internal functions of envfetch</h1>
            
      

      <div class="d-none name"><code>using-internal-functions-of-envfetch.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>There are multiple functions used by the main wrapper
<code>envfetch</code> function. If you’d like to use these, we have
replicated the main README.md functionality, using the internal
functions of envfetch, below.</p>
<div class="section level3">
<h3 id="setup-table-of-data-with-throw">1. Setup table of data with <code>throw</code><a class="anchor" aria-label="anchor" href="#setup-table-of-data-with-throw"></a>
</h3>
<p>Use of envfetch starts with a table: a <code>dataframe</code>,
<code>tibble</code> or <code>sf</code> object.</p>
<p>To begin, we need to create a data table containing a grid of points
over Australia for a range of times.</p>
<p>For most applications, you will have your own dataset. If you have
your own data, load that in as a variable called <code>d</code>.</p>
<p>However, for this example, we can generate this using the
<code>throw</code> function.</p>
<div id="example" class="chunk">
<div class="rcode">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jakemanger.github.io/envfetch/">envfetch</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/throw.html">throw</a></span><span class="op">(</span></span>
<span>  offset<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">128</span>, <span class="op">-</span><span class="fl">30</span><span class="op">)</span>,</span>
<span>  cellsize<span class="op">=</span><span class="fl">1</span>,</span>
<span>  n<span class="op">=</span><span class="fl">10</span>,</span>
<span>  time_interval<span class="op">=</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">interval</a></span><span class="op">(</span>start<span class="op">=</span><span class="st">'2017-01-01'</span>, end<span class="op">=</span><span class="st">'2017-01-02'</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<p>The data set should look like this:</p>
<div id="unnamed-chunk-2" class="chunk">
<div class="rcode">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span></code></pre></div>
<div class="output">
<pre class="knitr r">##             time_column                  geometry  
##  Intervals        :100          POINT        :100  
##  Earliest endpoint:2017-01-01   epsg:4326    :  0  
##  Latest endpoint  :2017-01-02   +proj=long...:  0  
##  Time zone        :UTC
</pre>
</div>
</div>
</div>
<p>And can be visualized with a plot:</p>
<div id="unnamed-chunk-3" class="chunk">
<div class="rcode">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearth/" class="external-link">rnaturalearth</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearthdata/" class="external-link">rnaturalearthdata</a></span><span class="op">)</span></span></code></pre></div>
<div class="message">
<pre class="knitr r">## 
## Attaching package: 'rnaturalearthdata'
</pre>
</div>
<div class="message">
<pre class="knitr r">## The following object is masked from 'package:rnaturalearth':
## 
##     countries110
</pre>
</div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load map of australia for reference</span></span>
<span><span class="va">world</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html" class="external-link">ne_countries</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="st">"medium"</span>, returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="va">australia</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">world</span>, <span class="va">admin</span> <span class="op">==</span> <span class="st">"Australia"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">australia</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d</span>, size <span class="op">=</span> <span class="fl">1</span>, show.legend <span class="op">=</span> <span class="st">"point"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Australia with sample points"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<img src="using-internal-functions-of-envfetch_files/figure-html/unnamed-chunk-3-1.png" width="100%">
</div>
</div>
<p>Each data point in the table has a <code>sf::geometry</code> object
along with a <code>datetime</code> (a <code><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">lubridate::interval</a></code>
or a date string). Ensure data used with the envfetch package matches
this format.</p>
<p>This <code>geometry</code> may be a point or a polygon. You may also
just use plain old <code>x</code> and <code>y</code> coordinates as
separate columns.</p>
<p>Each individual data point will use the <code>datetime</code> object
to decide what time range to extract and summarise data in.
<code>datetime</code> can be a time range
(<code><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">lubridate::interval</a></code>), a single date
(e.g. <code>"20220101"</code>) or datetime
<code>"2010-08-03 00:50:50"</code>.</p>
</div>
<div class="section level3">
<h3 id="extract-from-your-data-sources-with-fetch">2. Extract from your data sources with <code>fetch</code><a class="anchor" aria-label="anchor" href="#extract-from-your-data-sources-with-fetch"></a>
</h3>
<p><strong><code>fetch</code></strong>:</p>
<ul>
<li>passes your data through your supplied extraction functions,</li>
<li>caches progress, so that if your function crashes somewhere, you can
continue where you left off and</li>
<li>allows you to repeat sampling across different times (see section 3,
below).</li>
</ul>
<p>You can supply any data extraction function to <code>fetch</code>,
but some useful built-in data extraction functions are provided:</p>
<table class="table">
<colgroup>
<col width="20%">
<col width="79%">
</colgroup>
<thead><tr class="header">
<th>Function name</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>extract_over_time</code></td>
<td>Extract and summarise raster data over multiple time periods for
each row in your dataset.</td>
</tr>
<tr class="even">
<td><code>extract_over_space</code></td>
<td>Extract and summarise raster data over space for each row in your
dataset.</td>
</tr>
<tr class="odd">
<td><code>extract_gee</code></td>
<td>Use Google Earth Engine to extract your chosen image collection
bands and summarise this information for each row in your dataset.</td>
</tr>
<tr class="even">
<td><code>get_daynight_times</code></td>
<td>Calculates the time since sunrise, time since sunset and day and
night hours for each row in your dataset.</td>
</tr>
</tbody>
</table>
<p>Note, the <code>get_daynight_times</code> function provides an
example of how you could extend the caching mechanism of
<code>envfetch</code> for a purpose other than extracting data from
raster files.</p>
<p>In this example, we will use:</p>
<ul>
<li><p><code>extract_over_time</code> to extract from a large
pre-downloaded NetCDF file</p></li>
<li><p><code>extract_gee</code> to extract NDVI data from the MODIS
MOD13Q1 dataset on Google Earth Engine</p></li>
</ul>
<p>To fetch the data, use the <strong><code>fetch</code></strong>
function and supply it with the extraction functions you would like to
use. You can supply your own custom function here, but ensure you use
the anonymous function syntax so you can specify custom arguments. That
is, if following <code>purrr</code> formula syntax:
<code>~your_function(.x, custom_arg='arg_value')</code> or if following
base R,
<code>function(x) your_function(x, custom_arg='arg_value')</code>).
Note, <code>.x</code> in the below example is your data set,
<code>d</code>.</p>
<div id="unnamed-chunk-4" class="chunk">
<div class="rcode">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extracted</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/fetch.html">fetch</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="fu"><a href="../reference/extract_over_time.html">extract_over_time</a></span><span class="op">(</span><span class="va">.x</span>, r <span class="op">=</span> <span class="st">'/path/to/netcdf.nc'</span><span class="op">)</span>,</span>
<span>    <span class="op">~</span><span class="fu"><a href="../reference/extract_gee.html">extract_gee</a></span><span class="op">(</span></span>
<span>       <span class="va">.x</span>,</span>
<span>       collection_name<span class="op">=</span><span class="st">'MODIS/061/MOD13Q1'</span>,</span>
<span>       bands<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'NDVI'</span>, <span class="st">'DetailedQA'</span><span class="op">)</span>,</span>
<span>       time_buffer<span class="op">=</span><span class="fl">16</span>,</span>
<span>     <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="obtain-data-for-repeated-time-intervals">3. Obtain data for repeated time intervals<a class="anchor" aria-label="anchor" href="#obtain-data-for-repeated-time-intervals"></a>
</h3>
<p>In certain applications, you may need to obtain environmental data
from repeated previous time periods. For example, we can extract data
from the past six months relative to the time (start time if an interval
is provided) of each data point, with an average calculated for each
two-week block, using the <strong><code>.time_rep</code></strong>
variable.</p>
<div id="unnamed-chunk-5" class="chunk">
<div class="rcode">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_extracted</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/fetch.html">fetch</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="fu"><a href="../reference/extract_over_time.html">extract_over_time</a></span><span class="op">(</span><span class="va">.x</span>, r <span class="op">=</span> <span class="st">'/path/to/netcdf.nc'</span><span class="op">)</span>,</span>
<span>    <span class="op">~</span><span class="fu"><a href="../reference/extract_gee.html">extract_gee</a></span><span class="op">(</span></span>
<span>       <span class="va">.x</span>,</span>
<span>       collection_name<span class="op">=</span><span class="st">'MODIS/061/MOD13Q1'</span>,</span>
<span>       bands<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'NDVI'</span>, <span class="st">'DetailedQA'</span><span class="op">)</span>,</span>
<span>       time_buffer<span class="op">=</span><span class="fl">16</span>,</span>
<span>     <span class="op">)</span>,</span>
<span>    .time_rep<span class="op">=</span><span class="fu"><a href="../reference/time_rep.html">time_rep</a></span><span class="op">(</span>interval<span class="op">=</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">14</span><span class="op">)</span>, n_start<span class="op">=</span><span class="op">-</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="integrate-other-packages-and-create-your-own-fetch-function">Integrate other packages and create your own fetch function<a class="anchor" aria-label="anchor" href="#integrate-other-packages-and-create-your-own-fetch-function"></a>
</h2>
<p>In some cases, you may want to combine envfetch with other third
party tools. Below, we will illustrate how to do this with the <a href="https://github.com/ropensci/weatherOz" class="external-link">weatherOz</a> R package.
Visit the link to see their project details and licensing.</p>
<div id="unnamed-chunk-6" class="chunk">
<div class="rcode">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("weatherOz", repos = "https://ropensci.r-universe.dev")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">weatherOz</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jakemanger.github.io/envfetch/">envfetch</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cli.r-lib.org" class="external-link">cli</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># authenticate with SILO using the weatherOz package</span></span>
<span><span class="fu">get_key</span><span class="op">(</span>service <span class="op">=</span> <span class="st">"SILO"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make a wrapper function to adapt weatherOz for envfetch data inputs </span></span>
<span><span class="va">get_data_drill_wrapper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">summary_fn</span><span class="op">=</span><span class="va">mean</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">points</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">points</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://cli.r-lib.org/reference/cli_progress_step.html" class="external-link">cli_progress_step</a></span><span class="op">(</span><span class="st">"Fetching weather data for {nrow(coords)} location{?s}"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">map</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://cli.r-lib.org/reference/cli_progress_message.html" class="external-link">cli_progress_message</a></span><span class="op">(</span><span class="st">"Processing location {i}/{nrow(coords)}"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">int_start</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">time_column</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">int_end</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">time_column</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># use a tryCatch as requests with no result raise errors</span></span>
<span>    <span class="co"># we just want NAs in those cases.</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>      <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">get_data_drill</span><span class="op">(</span></span>
<span>        latitude <span class="op">=</span> <span class="va">coords</span><span class="op">$</span><span class="va">Y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>        longitude <span class="op">=</span> <span class="va">coords</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>        start_date <span class="op">=</span> <span class="va">start_date</span>,</span>
<span>        end_date <span class="op">=</span> <span class="va">end_date</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="co"># aggregate the data for this location</span></span>
<span>      <span class="va">summarised</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="fu">any_of</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"date"</span>, <span class="st">"latitude"</span>, <span class="st">"longitude"</span>, <span class="st">"date"</span>, <span class="st">"extracted"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">summarise</span><span class="op">(</span></span>
<span>          <span class="co"># summarise everything except elevation</span></span>
<span>          <span class="fu">across</span><span class="op">(</span><span class="op">-</span><span class="va">elev_m</span>, <span class="op">~</span> <span class="fu">summary_fn</span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          <span class="co"># special-case elevation: strip " m", convert numeric, summarise</span></span>
<span>          elev_m <span class="op">=</span> <span class="fu">summary_fn</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" m$"</span>, <span class="st">""</span>, <span class="va">elev_m</span><span class="op">)</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">summarised</span><span class="op">)</span></span>
<span>    <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://cli.r-lib.org/reference/cli_alert.html" class="external-link">cli_alert_warning</a></span><span class="op">(</span><span class="st">"Error for location {i}: {e$message}"</span><span class="op">)</span></span>
<span>      <span class="co"># return a row with NAs but proper structure</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">tibble</span><span class="op">(</span></span>
<span>        latitude <span class="op">=</span> <span class="va">coords</span><span class="op">$</span><span class="va">Y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>        longitude <span class="op">=</span> <span class="va">coords</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>        date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,</span>
<span>        max_temp <span class="op">=</span> <span class="cn">NA_real_</span>,</span>
<span>        min_temp <span class="op">=</span> <span class="cn">NA_real_</span>,</span>
<span>        rain <span class="op">=</span> <span class="cn">NA_real_</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">combined_results</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span>  <span class="va">combined_results</span> <span class="op">&lt;-</span> <span class="va">combined_results</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">combined_results</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># extract with the `fetch` function from `envfetch`</span></span>
<span><span class="va">extracted_weatherOz</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/fetch.html">fetch</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="fu">get_data_drill_wrapper</span><span class="op">(</span><span class="va">.x</span>, <span class="va">mean</span><span class="op">)</span>,</span>
<span>    use_cache <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
<p>Then, if you want to obtain that environmental data from repeated
previous time periods, you can again add the time_rep value.</p>
<p>Here we extract data from the past six months relative to the time
(start time if an interval is provided) of each data point, with an
average calculated for each two-week block, using the
<strong><code>.time_rep</code></strong> variable.</p>
<div id="unnamed-chunk-7" class="chunk">
<div class="rcode">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># extract with the `fetch` function from `envfetch`</span></span>
<span><span class="co"># and repeat extractions calculating averages for each two-week block for the last</span></span>
<span><span class="co"># 6 months</span></span>
<span><span class="va">extracted_weatherOz</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/fetch.html">fetch</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="fu">get_data_drill_wrapper</span><span class="op">(</span><span class="va">.x</span>, <span class="va">mean</span><span class="op">)</span>,</span>
<span>    use_cache <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    .time_rep<span class="op">=</span><span class="fu"><a href="../reference/time_rep.html">time_rep</a></span><span class="op">(</span>interval<span class="op">=</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">14</span><span class="op">)</span>, n_start<span class="op">=</span><span class="op">-</span><span class="fl">12</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jake Manger, Jacob Berson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
