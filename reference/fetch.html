<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Fetch data from each row using anonymous functions — fetch • envfetch</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fetch data from each row using anonymous functions — fetch"><meta name="description" content="This function passes your data through your supplied extraction functions,
caches progress, so that if your function crashes somewhere, you can continue
where you left off, shows progress and estimated time to completion and
allows you to repeat sampling across different times."><meta property="og:description" content="This function passes your data through your supplied extraction functions,
caches progress, so that if your function crashes somewhere, you can continue
where you left off, shows progress and estimated time to completion and
allows you to repeat sampling across different times."><meta property="og:image" content="https://jakemanger.github.io/envfetch/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">envfetch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/comparison.html">Comparison with other extraction methods</a></li>
    <li><a class="dropdown-item" href="../articles/using-internal-functions-of-envfetch.html">Using internal functions of envfetch</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fetch data from each row using anonymous functions</h1>

      <div class="d-none name"><code>fetch.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function passes your data through your supplied extraction functions,
caches progress, so that if your function crashes somewhere, you can continue
where you left off, shows progress and estimated time to completion and
allows you to repeat sampling across different times.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">fetch</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  use_cache <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  out_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"./output/"</span><span class="op">)</span>,</span>
<span>  out_filename <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  cache_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">"cache/"</span><span class="op">)</span>,</span>
<span>  cache_files <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  time_column_name <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  .time_rep <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">20000</span>,</span>
<span>  funs_to_use_batch_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"extract_gee"</span><span class="op">)</span>,</span>
<span>  do_initial_sort <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  use_space_in_initial_sort <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>A tibble with a <code>sf</code> "geometry" and a column with time (a
<code>lubridate</code> interval or date), detected automatically or specified by the
<code>time_column_name</code> parameter.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Arguments passed on to <code><a href="extract_over_time.html">extract_over_time</a></code>, <code><a href="extract_gee.html">extract_gee</a></code></p><dl><dt><code>r</code></dt>
<dd><p>A file path to a raster file or a SpatRaster object from the terra
package. This is the raster data.
source from which the data will be extracted.</p></dd>

    <dt><code>subds</code></dt>
<dd><p>positive integer or character to select a sub-dataset to extract
from. If zero or "", all sub-datasets are extracted.</p></dd>

    <dt><code>temporal_fun</code></dt>
<dd><p>A function used to summarise multiple data points
found within a time interval. Default is <code>rowMeans(x, na.rm=TRUE)</code>. The user
can supply vectorised summarisation functions (using rowMeans or rowSums) or
non-vectorised summarisation functions (e.g., <code>sum</code>, <code>mean</code>, <code>min</code>, <code>max</code>).
If supplying a custom vectorised <code>temporal_fun</code>, set
<code>is_vectorised_temporal_fun</code> to <code>TRUE</code> to ensure the vectorised approach is
used for performance. Note, vectorised summarisation functions are not
possible when <code>fun=NULL</code> and you are extracting with polygon or line
geometries (i.e. <code>temporal_fun</code> is used to summarise, treating each time and
space value independently).</p></dd>

    <dt><code>spatial_extraction_fun</code></dt>
<dd><p>A function used to extract points spatially for
each time slice of the raster. Default is the default implementation of
<code>extract_over_space</code> (extracts the <code>mean</code> of geometries within rasters,
removing NAs).</p></dd>

    <dt><code>scale</code></dt>
<dd><p>The scale to aggregate your raster to (in units of the
original raster). Note this will be rounded to fit the nearest aggregation
factor (number of cells in each direction). Leave as NULL (the default) if
you do not want any aggregation. See <a href="https://rspatial.github.io/terra/reference/aggregate.html" class="external-link">aggregate</a>.</p></dd>

    <dt><code>time_buffer</code></dt>
<dd><p>Time buffer used to adjust the time interval for data
extraction. The function always uses the time before and after the interval
to prevent errors when summarising the earliest and latest times. Default is
0 days.</p></dd>

    <dt><code>debug</code></dt>
<dd><p>If TRUE, pauses the function and displays a plot for each
extracted point. This is useful for debugging unexpected extracted values.
Default is FALSE.</p></dd>

    <dt><code>override_terraOptions</code></dt>
<dd><p>If TRUE, overrides terra's default terraOptions
with those specified in the envfetch's package. Default is TRUE.</p></dd>

    <dt><code>is_vectorised_summarisation_function</code></dt>
<dd><p>Whether the summarisation is
vectorised (like rowSums or rowMeans). Is only necessary to be TRUE if the
row-wise vectorised summarisation function has not been automatically
detected (does not use rowSums or rowMeans).</p></dd>

    <dt><code>trim_raster</code></dt>
<dd><p>Whether to trim the raster to time bounds as a performance
optimisation. Defaults to TRUE.</p></dd>

    <dt><code>subset_raster_indices</code></dt>
<dd><p>Whether to subset raster by time indices as a
performance optimisation. Defaults to TRUE.</p></dd>

    <dt><code>collection_name</code></dt>
<dd><p>A character string representing the Google Earth
Engine image collection from which to extract data.</p></dd>

    <dt><code>bands</code></dt>
<dd><p>A vector of character strings representing the band names to
extract from the image collection.</p></dd>

    <dt><code>lazy</code></dt>
<dd><p>A logical indicating whether to download Google Earth Engine data
lazily with future::sequential objects to evaluate the task in the future.
Defaults to FALSE.</p></dd>

    <dt><code>initialise_gee</code></dt>
<dd><p>A logical indicating whether to initialise Google Earth
Engine within the function. Default is TRUE.</p></dd>

    <dt><code>use_gcs</code></dt>
<dd><p>A logical indicating whether to use Google Cloud Storage for
larger requests. Default is FALSE.</p></dd>

    <dt><code>use_drive</code></dt>
<dd><p>A logical indicating whether to use Google Drive for larger
requests. Default is FALSE.</p></dd>

    <dt><code>max_chunk_time_day_range</code></dt>
<dd><p>An string representing the maximum number of
time units to include in each time chunk when splitting the dataset for
efficient memory use on Google Earth Engine's end. Default is '3 months'.</p></dd>

    <dt><code>max_feature_collection_size</code></dt>
<dd><p>An integer representing the maximum number
of features (rows) to include in each chunk when splitting the dataset for
efficient memory use on Google Earth Engine's end. Default is 5000.</p></dd>

    <dt><code>ee_reducer_fun</code></dt>
<dd><p>A Google Earth Engine reducer function representing the
function used to aggregate the data extracted from each image. Default is
rgee::ee$Reducer$mean().</p></dd>


</dl></dd>


<dt id="arg-use-cache">use_cache<a class="anchor" aria-label="anchor" href="#arg-use-cache"></a></dt>
<dd><p>Whether to cache your progress. Allows you to continue where
you left off in case of an error or the process is interrupted. Also avoids
recomputing extractions between R sessions.</p></dd>


<dt id="arg-out-dir">out_dir<a class="anchor" aria-label="anchor" href="#arg-out-dir"></a></dt>
<dd><p>A directory to output your result. Is ignored if
out_filename = NA.</p></dd>


<dt id="arg-out-filename">out_filename<a class="anchor" aria-label="anchor" href="#arg-out-filename"></a></dt>
<dd><p>The path to output the result. Set to NA (the default) to
not save the result and only return the result.</p></dd>


<dt id="arg-overwrite">overwrite<a class="anchor" aria-label="anchor" href="#arg-overwrite"></a></dt>
<dd><p>Overwrite output file if exists.</p></dd>


<dt id="arg-cache-dir">cache_dir<a class="anchor" aria-label="anchor" href="#arg-cache-dir"></a></dt>
<dd><p>A directory to output cached progress. Is ignored if
use_cache = FALSE.</p></dd>


<dt id="arg-cache-files">cache_files<a class="anchor" aria-label="anchor" href="#arg-cache-files"></a></dt>
<dd><p>Paths to cached files. Specify these if the cache system
hasn't automatically detected your cache. Is ignored if use_cache = FALSE.</p></dd>


<dt id="arg-time-column-name">time_column_name<a class="anchor" aria-label="anchor" href="#arg-time-column-name"></a></dt>
<dd><p>Name of the time column in the dataset. If NULL
(the default), a column of type lubridate::interval is automatically
selected.</p></dd>


<dt id="arg--time-rep">.time_rep<a class="anchor" aria-label="anchor" href="#arg--time-rep"></a></dt>
<dd><p>A <code>time_rep</code> object. Used to repeat data extraction along
repeating time intervals before and after the original datetime. This can be
relative to the start or the end of the input time interval (specified by the
<code>relative_to_start</code> argument of <code>time_rep</code>). Defaults to the start.</p></dd>


<dt id="arg-batch-size">batch_size<a class="anchor" aria-label="anchor" href="#arg-batch-size"></a></dt>
<dd><p>The maximum number of rows or geometries to extract and
summarise at a time. Each batch will be cached to continue extraction in case
of interruptions. Larger batch sizes may result in overuse of rgee on the
server-side and hangs. Set <code>batch_size</code> to <code>1</code>, <code>NA</code> or <code>&lt;1</code> for no batching.
Use <code>funs_to_use_batch_size</code> to define what functions batch_size will be
used with.</p></dd>


<dt id="arg-funs-to-use-batch-size">funs_to_use_batch_size<a class="anchor" aria-label="anchor" href="#arg-funs-to-use-batch-size"></a></dt>
<dd><p>A vector with the names of functions you want
to use batch_size for. Batch size is useful for some functions
(rgee: <code>'extract_gee'</code>) but not others (local: <code>'extract_over_time'</code>).
Defaults to <code>c('extract_gee')</code>.</p></dd>


<dt id="arg-do-initial-sort">do_initial_sort<a class="anchor" aria-label="anchor" href="#arg-do-initial-sort"></a></dt>
<dd><p>Whether to initially sort the unique input data <code>x</code> by
space (if <code>use_space_in_initial_sort</code> is <code>TRUE</code>) and time for efficiency
during later extraction processes. Defaults to TRUE.</p></dd>


<dt id="arg-use-space-in-initial-sort">use_space_in_initial_sort<a class="anchor" aria-label="anchor" href="#arg-use-space-in-initial-sort"></a></dt>
<dd><p>Whether to initially sort the unique input
data <code>x</code> by space in addition to time for efficiency during later extraction
processes. Defaults to FALSE.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>tibble An augmented tibble with additional data fetched using
supplied functions.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="va">extracted</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">fetch</span><span class="op">(</span></span></span>
<span class="r-in"><span>    <span class="op">~</span><span class="fu">extract_across_times</span><span class="op">(</span><span class="va">.x</span>, r <span class="op">=</span> <span class="st">'/path/to/netcdf.nc'</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    <span class="op">~</span><span class="fu"><a href="extract_gee.html">extract_gee</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>       <span class="va">.x</span>,</span></span>
<span class="r-in"><span>       collection_name<span class="op">=</span><span class="st">'MODIS/061/MOD13Q1'</span>,</span></span>
<span class="r-in"><span>       bands<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'NDVI'</span>, <span class="st">'DetailedQA'</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>       time_buffer<span class="op">=</span><span class="fl">16</span>,</span></span>
<span class="r-in"><span>     <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># extract and summarise data every fortnight for the last six months</span></span></span>
<span class="r-in"><span><span class="co"># relative to the start of the time column in `d`</span></span></span>
<span class="r-in"><span><span class="va">rep_extracted</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">fetch</span><span class="op">(</span></span></span>
<span class="r-in"><span>    <span class="op">~</span><span class="fu">extract_across_times</span><span class="op">(</span><span class="va">.x</span>, r <span class="op">=</span> <span class="st">'/path/to/netcdf.nc'</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    <span class="op">~</span><span class="fu"><a href="extract_gee.html">extract_gee</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>       <span class="va">.x</span>,</span></span>
<span class="r-in"><span>       collection_name<span class="op">=</span><span class="st">'MODIS/061/MOD13Q1'</span>,</span></span>
<span class="r-in"><span>       bands<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'NDVI'</span>, <span class="st">'DetailedQA'</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>       time_buffer<span class="op">=</span><span class="fl">16</span>,</span></span>
<span class="r-in"><span>     <span class="op">)</span>,</span></span>
<span class="r-in"><span>    .time_rep<span class="op">=</span><span class="fu"><a href="time_rep.html">time_rep</a></span><span class="op">(</span>interval<span class="op">=</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">14</span><span class="op">)</span>, n_start<span class="op">=</span><span class="op">-</span><span class="fl">12</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jake Manger, Jacob Berson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

